{% extends "base.html" %}

{% load humanize %}
{% block content %}
<h3>{{ ticker.symbol }} - {{ ticker.company_name }}</h3>

<p>Last close price: <strong>{{ close_price }}</strong></p>

<h4>Trend and momentum</h4>
<p>Moving average 200 strength = abs(MA - price)/price: {{ ticker.ma_200_trend_strength }}</p>
<p>2 period cumulative RSI: <span style="color: {% if ticker.cumulative_two_period_two_day_rsi < 10 %}green{% elif ticker.cumulative_two_period_two_day_rsi > 65 %}red{% endif %};">{{ ticker.cumulative_two_period_two_day_rsi|floatformat:1 }}</span></p>
<p>Average volume (100 days): {{ ticker.avg_volume_100_days|floatformat:0 }}k</p>
<p>Average trade range: {{ ticker.atr|floatformat:2 }}</p>

<h4>Candlestick pattern from yesterday:</h4>
<p>Patterns detected: <strong>{{ patterns_detected }}</strong></p>
<p>Bullish pattern detected: <span style="color: {% if bullish_detected == 'True' %}green{% endif %}; {% if bullish_detected == 'True' %}font-weight:bold{% endif %};">{{ bullish_detected }}</span></p>
<p>Bullish reversal pattern detected: <span style="color: {% if bullish_reversal_detected == 'True' %}green{% endif %}; {% if bullish_reversal_detected == 'True' %}font-weight:bold{% endif %};">{{ bullish_reversal_detected }}</></p>
<p>Reversal pattern detected: <span style="{% if reversal_detected == 'True' %}font-weight:bold{% endif %};">{{ reversal_detected }}</p>
<p>Bearish pattern detected: <span style="color: {% if bearish_detected == 'True' %}red{% endif %}; {% if bearish_detected == 'True' %}font-weight:bold{% endif %};">{{ bearish_detected }}</span></p>

<h4>Support / Resistance Levels</h4>
<p>Currently at support / resistance level: <strong>
    <span style="color: {% if ticker.nearest_level_type == 'Support' %}green{% else %}red{% endif %};">
        {{ ticker.nearest_level_type }} at {{ ticker.nearest_level_value }}
    </span></strong>
</p>
<p>% of price to nearest support / resistance: {{ ticker.nearest_level_percent_distance|floatformat:1 }} %</p>
<p>Days since level was last retested: {{ ticker.nearest_level_days_since_retest }}</p>

<table>
    <thead>
        <tr>
            <th style="text-align:center; width: 20ch;">Datetime</th>
            <th style="text-align:center; width: 8ch;">Days ago</th>
            <th style="text-align:center; width: 8ch;">Level</th>
            <th style="text-align:center; width: 8ch;">Retest count</th>
            <th style="text-align:center; width: 10ch;">% from close price</th> <!-- New header -->
        </tr>
    </thead>
    <tbody>
        {% for sr_level in daily_prices %}
        <tr>
            <td>{{ sr_level.daily_price.datetime|date:"d/m/Y" }}</td>
            <td>{{ sr_level.days_from_today }}</td>
            <td style="color: {% if sr_level.daily_price.level > close_price %}red{% else %}green{% endif %};">
                {{ sr_level.daily_price.level }}
            </td>
            <td style="text-align:center;">{{ sr_level.daily_price.level_strength }}</td>
            <td style="text-align:center;">{{ sr_level.close_price_percentage|floatformat:2 }}%</td> <!-- New cell for displaying percentage -->
        </tr>
        </tr>
        {% endfor %}
    </tbody>
</table>
<h4>Manual Download</h4>
<p>Refresh the data:</p>
<ul>
    <li><a href="{% url 'manual_download' ticker.id 'day' %}">Download daily prices</a></li>
    <li><a href="{% url 'manual_download' ticker.id '15mins' %}">Download 15 mins prices</a></li>
    <li><a href="{% url 'manual_download' ticker.id '5mins' %}">Download 5 mins prices</a></li>
    <li><a href="{% url 'update_metrics' ticker.symbol %}">Recalculate Metrics</a></li>
</ul>

{% endblock %}
